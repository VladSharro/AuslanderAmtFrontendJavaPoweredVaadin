### Owner: Kirill Borisov
###
### The pipeline includes sample jobs for E2E tests and a skeleton for build.

stages:
  - precheck
  - build
  - test

fe-build-test:
  image: node:lts-alpine
  stage: precheck
  script:
    - cd Frontend
    - npm install
    - npm run build

fe-build:
  image: debian:stable
  stage: build
  when: manual
  before_script:
    - apt-get update
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - chmod 400 "$SSH_PRIVATE_KEY"
    - ssh-add "$SSH_PRIVATE_KEY"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - cp "$SSH_KNOWN_HOSTS" ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo $SUDO | ssh -tt borisov@boriso02.stud.fim.uni-passau.de 'cd aspd/team2; eval $(ssh-agent); ssh-add ~/.ssh/id_rsa; git checkout prod; git pull origin prod; sudo docker stop aspd; sudo docker rm aspd; sudo docker build -t aspd ./Frontend/; sudo docker run --name aspd -d -p 80:80 aspd'

be-build:
  image: debian:stable
  stage: build
  when: manual
  before_script:
    - apt-get update
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - chmod 400 "$SSH_PRIVATE_KEY"
    - ssh-add "$SSH_PRIVATE_KEY"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - cp "$SSH_KNOWN_HOSTS" ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo $SUDO | ssh -tt borisov@boriso02.stud.fim.uni-passau.de 'cd aspd/team2; eval $(ssh-agent); ssh-add ~/.ssh/id_rsa; git checkout main; git pull origin main; sudo docker stop aspdapp-for-amt; sudo docker rm app-for-amt; sudo docker build -t app-for-amt .; sudo docker run --name app-for-amt -d -p 8080:8080 app-for-amt'

e2e-test:
  image: ppandiyan/robotframework    # this is outdated, but i really couldn't care less at this point
  stage: test
  needs: ["fe-build"]
  script:
    - robot -d results Tests/ui/home.robot
  artifacts:
    paths:
      - results